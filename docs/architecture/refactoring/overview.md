# バックエンドリファクタリング 全体設計書

## 1. 背景と目的

### 1.1 背景

Furumaru は地域特産品を扱う EC マーケットプレイスプラットフォームとして運用されており、Go によるモジュラモノリス + レイヤードアーキテクチャを採用している。サービスの成長に伴い、以下の技術的課題が顕在化してきた。

1. **セキュリティリスクのある依存ライブラリ**: `satori/go.uuid` (CVE-2021-3538) や `golang/mock` (メンテナンス終了) など、脆弱性やサポート終了のライブラリが残存
2. **メジャーバージョン遅れの決済系ライブラリ**: `stripe-go` が11メジャーバージョン遅れ、`line-bot-sdk-go` が非推奨バージョン
3. **Gateway 層の肥大化**: handler.go が300行超、registry.go のDI初期化が310行超の単一関数
4. **GORM 利用パターンの改善余地**: Preload 未使用による冗長な fill() パターン、JSON ラッパー型の重複

### 1.2 目的

本リファクタリングの目的は以下の通りである。

- **セキュリティリスクの排除**: 脆弱性のある依存ライブラリを安全な代替に移行する
- **保守性の向上**: Gateway 層の責務分割と DI パターンの改善により、コードの見通しと変更容易性を高める
- **開発効率の改善**: GORM のベストプラクティス適用とテスト基盤の強化により、開発サイクルを加速する
- **技術的持続性の確保**: Go 言語および主要ライブラリを最新の安定バージョンに維持する

## 2. 現状アーキテクチャの評価

### 2.1 全体構成

```
Gateway (Gin HTTP)
  └─ Service Interface
       └─ Service Implementation
            └─ Database (TiDB/GORM)
                 └─ Entity
```

- 4つのドメインモジュール: User (114メソッド), Store (175+メソッド), Media (84メソッド), Messenger (51メソッド)
- 合計 424+ サービスメソッド
- 4つの独立DB: users, stores, media, messengers (全て TiDB)

### 2.2 強み (維持すべき点)

| 領域 | 評価 |
|------|------|
| モジュラモノリス構成 | ドメイン境界が明確。2026年のトレンド（マイクロサービスからの回帰）とも合致 |
| レイヤード設計 | api / service / database / entity の4層が明確に分離 |
| TiDB リトライ機構 | 指数バックオフ付きの堅牢なトランザクション管理 |
| エラーハンドリング | 包括的なエラー分類と統一レスポンス |
| スキーマ管理 | SQL ベースで監査可能 |

### 2.3 改善が必要な点

| 領域 | 課題 | 深刻度 |
|------|------|--------|
| 依存ライブラリ | セキュリティ脆弱性 (CVE-2021-3538) | 高 |
| 依存ライブラリ | 決済系ライブラリの大幅バージョン遅れ | 高 |
| Gateway 層 | handler.go / registry.go の責務過多 | 中 |
| GORM 利用 | Preload 未使用、JSON型重複、非標準パターン | 中 |
| テスト基盤 | 外部キー制約無視、コンテナベーステスト未導入 | 中 |
| DI パターン | inject() メソッドの肥大化、サービス間相互参照 | 低〜中 |

### 2.4 GORM 利用パターンの現状評価: 7.5/10

強固なリトライ機構とトランザクション管理を持つ一方、Preload や GORM 標準 API の活用に改善余地がある。

## 3. リファクタリングの全体方針

### 3.1 基本原則

1. **段階的移行**: ビッグバンリファクタリングを避け、フェーズごとに完結する変更を行う
2. **後方互換性の維持**: 外部 API の互換性を壊さない
3. **テストファーストの強化**: 各フェーズで既存テストを壊さず、カバレッジを維持・向上する
4. **セキュリティ最優先**: 脆弱性のある依存は最優先で対応する
5. **既存パターンの尊重**: 動いているコードの無意味な書き換えを避ける

### 3.2 参考プロジェクト: mytec

社内の mytec プロジェクトで採用されている以下のパターンを参考にする。

- handler/http/{admin,user}/ によるAPI対象別ハンドラー分割
- handler/http/staff/presenter/ によるレスポンス変換の分離
- adapter/database/, adapter/authz/ によるインフラ実装の分離
- testcontainers-go によるコンテナベース DB テスト

ただし、furumaru の既存設計を破壊的に変更するのではなく、段階的に取り入れる。

## 4. フェーズ分割

### Phase 1: セキュリティ・緊急対応 (1-2週間)

**目的**: セキュリティ脆弱性の排除とメンテナンス終了ライブラリの移行

- satori/go.uuid → google/uuid 完全移行
- golang/mock → go.uber.org/mock 完全移行
- go-grpc-middleware v1 → v2 完全移行
- Go パッチバージョンの適用

**成果物**: セキュリティ脆弱性ゼロの依存ツリー

### Phase 2: ライブラリアップグレード (2-4週間)

**目的**: メジャーバージョン遅れのライブラリを最新安定版に移行

- stripe-go v73 → v84 マイグレーション
- line-bot-sdk-go v7 → v8 マイグレーション
- sentry-go, Firebase SDK, gRPC 等の更新
- Go 1.26 移行検討

**成果物**: 全依存ライブラリが最新安定バージョン

### Phase 3: Gateway・構成改善 (1-2ヶ月)

**目的**: Gateway 層の保守性向上と DI パターンの改善

- handler.go の責務別分割
- registry.go の DI 初期化分割
- RBAC 同期間隔の短縮
- presenter パターンの導入検討

**成果物**: 見通しの良い Gateway 層と管理可能な DI 構成

### Phase 4: GORM・DB 改善 (1-2ヶ月)

**目的**: データアクセス層の品質向上とテスト基盤の強化

- GORM Preload 移行
- JSON カラム処理の統一
- Statement() → WithContext() 標準化
- testcontainers-go 導入
- テスト外部キー制約の正常化

**成果物**: 効率的なデータアクセスと信頼性の高いテスト基盤

### Phase 5: 将来的検討事項

**目的**: 中長期的な技術戦略の策定

- Connect-Go (connectrpc) の検討
- sqlc への段階的移行検討
- Go 1.26 新機能活用 (Green Tea GC, iterators)
- AI 開発生産性向上施策

**成果物**: 技術ロードマップの策定

## 5. 想定タイムライン

```
2026年 Q1 (3月)
├─ Phase 1: セキュリティ・緊急対応     [Week 1-2]
└─ Phase 2: ライブラリアップグレード   [Week 3-6]

2026年 Q2 (4-5月)
├─ Phase 3: Gateway・構成改善          [Month 1-2]
└─ Phase 4: GORM・DB改善              [Month 1-2] (Phase 3 と並行可能)

2026年 Q2-Q3 (5月以降)
└─ Phase 5: 将来的検討事項             [継続的]
```

Phase 3 と Phase 4 は独立したモジュールに対する変更のため、並行して進行可能である。

## 6. リスクと緩和策

### 6.1 技術的リスク

| リスク | 影響度 | 発生確率 | 緩和策 |
|--------|--------|----------|--------|
| stripe-go v84 移行時の決済機能回帰 | 高 | 中 | ステージング環境での決済フロー全パステスト、段階的ロールアウト |
| LINE SDK v8 移行時の認証連携不具合 | 高 | 中 | LINE 開発環境での事前検証、フィーチャーフラグによる切り替え |
| Gateway 分割時のルーティング不整合 | 中 | 低 | 既存 E2E テストの活用、分割前後でのエンドポイント一覧比較 |
| GORM Preload 移行時のクエリ性能変化 | 中 | 中 | ベンチマークテストの実施、slow query ログの監視強化 |

### 6.2 プロジェクトリスク

| リスク | 影響度 | 発生確率 | 緩和策 |
|--------|--------|----------|--------|
| リファクタリングと機能開発の競合 | 中 | 高 | フェーズごとの完結性を確保、feature freeze 不要な設計 |
| リファクタリング範囲の拡大 | 中 | 中 | フェーズごとのスコープ厳守、追加作業は次フェーズに先送り |
| レビュー負荷の増加 | 低 | 中 | 小さな PR に分割、自動レビュー (lint, test) の活用 |

### 6.3 ロールバック戦略

- 各フェーズの変更は独立したブランチで管理し、問題発生時に個別にリバート可能とする
- 特に決済系 (stripe-go) と認証系 (LINE SDK) の移行はフィーチャーフラグで制御する
- DB スキーマ変更を伴う場合は、前方互換性のあるマイグレーションのみを許可する

## 7. 関連ドキュメント

- [詳細設計書](./detailed-design.md) - フェーズごとの具体的な実装方針と ToDo
- [ADR一覧](./adr/) - アーキテクチャ決定記録
  - [ADR-001: 依存ライブラリのアップグレード戦略](./adr/001-dependency-upgrade-strategy.md)
  - [ADR-002: モジュラモノリスアーキテクチャの継続](./adr/002-modular-monolith-continuation.md)
  - [ADR-003: Gateway層のリストラクチャリング](./adr/003-gateway-restructuring.md)
  - [ADR-004: GORMベストプラクティスの適用](./adr/004-gorm-best-practices.md)
  - [ADR-005: コンテナベーステストへの移行](./adr/005-container-based-testing.md)
  - [ADR-006: AI活用を前提とした開発生産性向上](./adr/006-ai-developer-productivity.md)
- [既存アーキテクチャ概要](../overview.md) - 現行システム構成
- [設計決定記録](../design-decisions.md) - 既存のアーキテクチャ設計決定
