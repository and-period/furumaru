# ADR-003: Gateway層のリストラクチャリング

## ステータス

承認済み

## 日付

2026-02-21

## コンテキスト

現行の Gateway 層には以下の構造的問題がある。

### handler.go の肥大化
- 300行超で30+エンドポイントを1ファイルで管理している
- 認証、ユーザー管理、EC、メディア、Webhook など異なるドメインのハンドラーが混在
- 複数人で並行開発するとコンフリクトが頻発する

### registry.go の DI 初期化の巨大化
- inject() 関数が310行超の単一関数
- AWS クライアント、DB 接続、サービス層、ミドルウェアの初期化が一つの関数に凝集
- 依存関係の見通しが悪く、変更時の影響範囲が把握しづらい

### RBAC 同期の遅延
- 権限同期が5分間隔で実行されている
- 権限変更から反映まで最大5分の遅延が生じる
- セキュリティ上のリスク (権限剥奪が即時反映されない)

### 参考: mytec プロジェクトのパターン
mytec プロジェクトでは以下の分割パターンを採用しており、保守性が高い。
- `handler/http/{staff,user}/` でAPI対象別にハンドラーを分割
- `handler/http/request/`, `response/` で共通I/O処理を分離
- `handler/http/staff/presenter/` でレスポンス変換を分離

## 決定

Gateway 層を以下の方針でリストラクチャリングする。

### 1. handler.go のドメイン別分割

handler.go を以下のファイルに分割する。

```
api/internal/gateway/
├── handler.go              # 共通処理・ルーター初期化のみ
├── handler_auth.go         # 認証・認可関連
├── handler_user.go         # ユーザー管理
├── handler_store.go        # 商品・注文・決済
├── handler_media.go        # メディア・ライブ配信
├── handler_messenger.go    # 通知・メッセージ
└── handler_webhook.go      # Webhook処理
```

### 2. registry.go の関心事別分割

inject() 関数を関心事ごとのサブ関数に分割し、ファイルも分離する。

```go
func (r *registry) inject() {
    r.injectAWS()
    r.injectDatabase()
    r.injectServices()
    r.injectMiddleware()
}
```

### 3. RBAC 同期間隔の短縮

同期間隔を5分から1分に短縮する。

### 4. Presenter パターンの段階的導入

新規エンドポイントから presenter パターンを試験導入し、効果を検証した後に既存エンドポイントへ展開する。

## 検討した選択肢

### 選択肢1: 現状維持
- 利点: 変更コストゼロ
- 欠点: 肥大化が進行し保守性が継続的に低下
- **却下**: 技術的負債の蓄積

### 選択肢2: ドメイン別ファイル分割 (採用)
- 利点: 低リスク (同一パッケージ内の分割)、段階的に実施可能、コンフリクト削減
- 欠点: パッケージ構造自体は変わらないため根本的な改善には限界あり
- **採用**: リスクと効果のバランスが最適

### 選択肢3: パッケージレベルの再構成 (mytec 完全準拠)
- 利点: mytec と統一されたパッケージ構造、完全な責務分離
- 欠点: 変更範囲が広大、全エンドポイントの書き換え、テストの大規模修正が必要
- **却下**: 現段階ではリスクが高すぎる。Phase 3 の結果を見て将来的に再検討

### 選択肢4: API Gateway を別サービスに分離
- 利点: Gateway の独立スケーリング
- 欠点: ADR-002 (モジュラモノリス継続) と矛盾、運用複雑性増
- **却下**: アーキテクチャ方針と不整合

## 結果

### 期待される効果
- handler.go のファイルサイズを各50-80行程度に縮小
- 複数人での並行開発時のコンフリクト削減
- inject() 関数の可読性向上 (310行 → 各50-80行の4関数)
- RBAC 権限変更の反映遅延を最大1分に短縮

### 受け入れるトレードオフ
- ファイル数の増加 (1ファイル → 6-7ファイル)
- パッケージ構造自体は変更しないため、根本的な設計改善には限界がある
- Presenter パターンは試験導入のため、全面展開の保証はない

### 実施上の制約
- ルーティング構造 (URL パス、HTTPメソッド) は一切変更しない
- 既存テストを全て PASS させた状態で分割を行う
- 分割は1ファイルずつ PR を分けて実施する

## 関連

- [全体設計書](../overview.md)
- [詳細設計書 Phase 3](../detailed-design.md#phase-3-gateway構成改善-1-2ヶ月)
- [ADR-002: モジュラモノリスアーキテクチャの継続](./002-modular-monolith-continuation.md)
