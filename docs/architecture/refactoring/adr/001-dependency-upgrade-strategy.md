# ADR-001: 依存ライブラリのアップグレード戦略

## ステータス

承認済み

## 日付

2026-02-21

## コンテキスト

Furumaru プロジェクトの依存ライブラリに対するセキュリティ監査の結果、以下の問題が判明した。

### セキュリティ上の致命的問題
- **satori/go.uuid v1.2.0**: CVE-2021-3538 (予測可能な UUID 生成) の脆弱性を持ち、リポジトリが放棄されている
- **golang/mock v1.6.0**: Google によるメンテナンスが終了しており、セキュリティパッチが提供されない

### 高優先度の遅延
- **stripe-go v73**: 最新 v84 に対して11メジャーバージョン遅れ。決済系ライブラリとしてセキュリティリスクが大きい
- **line-bot-sdk-go v7**: v7 は非推奨。v8 (OpenAPI ベース) への移行が必要
- **go-grpc-middleware v1**: deprecated。v2 への完全移行が必要

### その他の遅延
- sentry-go: 4マイナーバージョン遅れ
- Firebase SDK: 1マイナーバージョン遅れ
- gRPC: 2マイナーバージョン遅れ

なお、主要ライブラリ (gin, gorm, testify, protobuf) は最新に維持されている。

## 決定

依存ライブラリのアップグレードを以下の優先度に基づいて段階的に実施する。

### 優先度1: セキュリティ脆弱性 (1-2週間)

セキュリティ脆弱性を持つライブラリ、およびメンテナンス終了ライブラリを最優先で移行する。

| 現行 | 移行先 | 理由 |
|------|--------|------|
| satori/go.uuid v1.2.0 | google/uuid | CVE-2021-3538、リポジトリ放棄 |
| golang/mock v1.6.0 | go.uber.org/mock | メンテナンス終了 |
| go-grpc-middleware v1 | go-grpc-middleware v2 | deprecated |

### 優先度2: メジャーバージョン遅れ (2-4週間)

ビジネスインパクトの大きい決済・認証系ライブラリを移行する。

| 現行 | 移行先 | 理由 |
|------|--------|------|
| stripe-go v73 | stripe-go v84 | 11バージョン遅れ、決済セキュリティ |
| line-bot-sdk-go v7 | line-bot-sdk-go v8 | v7非推奨 |

### 優先度3: マイナーバージョン遅れ (並行実施)

リスクの低いマイナーバージョンアップを一括で実施する。

## 検討した選択肢

### 選択肢1: 全ライブラリ一括アップグレード
- 利点: 一度に完了
- 欠点: 回帰リスクが極めて高い、問題切り分けが困難、レビュー負荷が巨大
- **却下**: リスクが高すぎる

### 選択肢2: 段階的アップグレード (採用)
- 利点: リスクが局所化される、PR 単位でレビュー可能、問題時にリバートが容易
- 欠点: 全体の完了まで時間がかかる
- **採用**: 安全性と保守性のバランスが最適

### 選択肢3: 必要になるまで放置
- 利点: 作業コストゼロ
- 欠点: セキュリティリスクの放置、CVE 公開による信用リスク
- **却下**: セキュリティ上許容できない

## 結果

### 期待される効果
- セキュリティ脆弱性の排除
- メンテナンスされたライブラリへの移行による長期的な安定性
- 最新 API 機能の活用可能性

### 受け入れるトレードオフ
- 段階的移行に伴う期間の長期化 (6-8週間)
- 各フェーズでのテスト・検証コスト
- stripe-go / LINE SDK の API 変更に伴うコード修正コスト

### リスク
- stripe-go v84 移行時の決済フロー回帰 → ステージング環境での全パステストで緩和
- LINE SDK v8 移行時の認証連携不具合 → LINE 開発環境での事前検証で緩和

## 関連

- [全体設計書](../overview.md)
- [詳細設計書 Phase 1-2](../detailed-design.md#phase-1-セキュリティ緊急対応-1-2週間)
