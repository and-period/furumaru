service: mediaService

frameworkVersion: "3"

provider:
  name: aws
  runtime: nodejs18.x
  account: ${self:custom.envMap.${self:provider.stage}.accountId}
  stage: ${opt:stage, self:custom.defaultStage}
  region: ${self:custom.envMap.${self:provider.stage}.region}
  vpc:
    securityGroupIds: ${self:custom.envMap.${self:provider.stage}.vpc.securityGroups}
    subnetIds: ${self:custom.envMap.${self:provider.stage}.vpc.subnetIds}
  iam:
    role: defaultRole

custom:
  defaultStage: stg
  envMap:
    prd: ${file(env/prd.yaml)}
    stg: ${file(env/stg.yaml)}

resources:
  Resources:
    defaultRole:
      Type: AWS::IAM::Role
      Properties:
        AssumeRolePolicyDocument:
          Version: "2012-10-17"
          Statement:
            - Effect: "Allow"
              Principal:
                AWS:
                  - '*'
              Action:
                - "sts:AssumeRole"
        Policies:
          - PolicyName: defaultPolicy
            PolicyDocument:
              Version: "2012-10-17"
              Statement:
                - Effect: Allow
                  Action:
                    - logs:CreateLogGroup
                    - logs:CreateLogStream
                    - logs:PutLogEvents
                    - lambda:InvokeFunction
                  Resource:
                    - '*'
          - PolicyName: automateMediaServicePolicy
            PolicyDocument:
              Version: "2012-10-17"
              Statement:
                - Effect: Allow
                  Action:
                    - mediaLive:CreateInput
                    - mediaLive:DescribeInput
                    - mediaLive:DeleteInput
                    - mediaLive:DescribeChannel
                    - mediaLive:CreateChannel
                    - mediaLive:DeleteChannel
                    - mediaStore:CreateContainer
                    - mediaStore:DescribeContainer
                    - mediaStore:PutContainerPolicy
                    - mediaStore:PutCorsPolicy
                    - mediaStore:PutLifecyclePolicy
                    - mediastore:DeleteContainer
                    - cloudfront:CreateOriginAccessControl
                    - cloudFront:CreateDistribution
                    - cloudFront:GetDistribution
                    - cloudFront:GetDistributionConfig
                    - cloudFront:DeleteDistribution
                    - iam:PassRole
                  Resource:
                    - '*'
    lambdaRole:
      Type: AWS::IAM::Role
      Properties:
        AssumeRolePolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Principal:
                Service:
                  - lambda.amazonaws.com
              Action: sts:AssumeRole
        Policies:
          - PolicyName: automateMediaServiceLambdaPolicy
            PolicyDocument:
              Version: "2012-10-17"
              Statement:
                - Effect: Allow
                  Action:
                    - ec2:CreateNetworkInterface
                    - ec2:DescribeNetworkInterfaces
                    - ec2:DeleteNetworkInterface
                  Resource:
                    - '*'
                - Effect: Allow
                  Action:
                    - logs:CreateLogGroup
                    - logs:CreateLogStream
                    - logs:PutLogEvents
                  Resource:
                    - '*'
                - Effect: Allow
                  Action:
                    - mediaStore:DescribeContainer
                    - mediaStore:ListItems
                    - mediaStore:DeleteObject
                  Resource:
                    - '*'
                - Effect: Allow
                  Action:
                    - cloudFront:GetDistribution
                    - cloudFront:GetDistributionConfig
                    - cloudFront:UpdateDistribution
                    - cloudFront:DeleteDistribution
                  Resource:
                    - '*'

functions:
  extractMediaStoreDomain:
    role: lambdaRole
    handler: functions/extractMediaStoreDomain/handler.extractDomainName
    memorySize: 128
    timeout: 10
  calculateMP4StartTime:
    role: lambdaRole
    handler: functions/calculateMP4StartTime/handler.calculateMP4StartTime
    memorySize: 128
    timeout: 10
  disableDistribution:
    role: lambdaRole
    handler: functions/disableDistribution/handler.disableDistribution
    memorySize: 128
    timeout: 10
  listMediaStoreItems:
    role: lambdaRole
    handler: functions/listMediaStoreItems/handler.listMediaStoreItems
    memorySize: 128
    timeout: 10
  deleteMediaStoreObjects:
    role: lambdaRole
    handler: functions/deleteMediaStoreObjects/handler.deleteMediaStoreObjects
    memorySize: 128
    timeout: 10

stepFunctions:
  stateMachines:
    mediaLiveStateMachine:
      name: mediaLiveStepFunction-${self:provider.stage}
      role:
        Fn::GetAtt: [defaultRole, Arn]
      definition:
        Comment: AutomateMediaServiceFunction
        StartAt: CreateMediaLiveInputAndContainer
        States:
          CreateMediaLiveInputAndContainer:
            Type: Parallel
            Comment: MediaLive入力とコンテナの作成を並列で実行
            InputPath: $
            Branches:
              - StartAt: CreateInput(RTMP)
                States:
                  CreateInput(RTMP):
                    Type: Task
                    End: true
                    Comment: ライブ配信 - ライブ配信入力用
                    Resource: arn:aws:states:::aws-sdk:medialive:createInput
                    InputPath: $.RtmpInput
                    ResultPath: $.RtmpResult
                    Parameters:
                      Name.$: States.UUID()
                      Type: RTMP_PUSH
                      Destinations:
                        - StreamName.$: $.StreamName
                      InputSecurityGroups:
                        - '4361039'
              - StartAt: CreateInput(MP4)
                States:
                  CreateInput(MP4):
                    Type: Task
                    End: true
                    Comment: ライブ配信 - オープニング動画入力用
                    Resource: arn:aws:states:::aws-sdk:medialive:createInput
                    InputPath: $.MP4Input
                    ResultPath: $.MP4Result
                    Parameters:
                      Name.$: States.UUID()
                      Type: MP4_FILE
                      Sources:
                        - Url.$: $.InputUrl
              - StartAt: CreateContainer
                States:
                  CreateContainer:
                    Type: Task
                    Comment: ライブ配信 - 配信用ストレージを作成
                    Resource: arn:aws:states:::aws-sdk:mediastore:createContainer
                    ResultPath: $.ContainerResult
                    Parameters:
                      ContainerName.$: States.UUID()
                    Next: DescribeContainer
                  DescribeContainer:
                    Type: Task
                    Comment: ライブ配信 - 配信用ストレージのステータスを取得する
                    ResultPath: $.ContainerStatus
                    Resource: arn:aws:states:::aws-sdk:mediastore:describeContainer
                    Parameters:
                      ContainerName.$: $.ContainerResult.Container.Name
                    Next: WaitActive
                  WaitActive:
                    Type: Wait
                    Seconds: 1
                    Next: CheckContainerActive
                  CheckContainerActive:
                    Type: Choice
                    InputPath: $
                    Choices:
                      - Variable: $.ContainerStatus.Container.Status
                        StringEquals: "ACTIVE"
                        Next: ExtractMediaStoreDomain
                      - Variable: $.ContainerStatus.Container.Status
                        StringEquals: "CREATING"
                        Next: DescribeContainer
                    Default: failed
                  ExtractMediaStoreDomain:
                    Type: Task
                    Comment: ライブ配信 - MediaStoreのドメイン名を抽出
                    InputPath: $
                    Resource:
                      Fn::GetAtt: [extractMediaStoreDomain, Arn]
                    ResultPath: $.ContainerStatus.Container.Endpoint
                    Next: success
                  success:
                    Type: Succeed
                  failed:
                    Type: Fail
            Next: CreateStreamingResoures
          CreateStreamingResoures:
            Type: Parallel
            Next: RegisterResoursesInfo
            Comment: 配信リソースの作成を並列で実行
            InputPath: $
            ResultSelector:
              ScheduleId.$: $[0][0].ScheduleId
              CloudFrontUrl.$: $[1][2].DistributionResult.Distribution.DomainName
              CloudFrontDistributionArn.$: $[1][2].DistributionResult.Distribution.Arn
              MediaLiveRtmpInputArn.$: $[0][0].RtmpResult.Input.Arn
              MediaLiveRtmpInputUrl.$: $[0][0].RtmpResult.Input.Destinations[0].Url
              MediaLiveRtmpInputName.$: $[0][0].RtmpResult.Input.Name
              MediaLiveRtmpStreamName.$: $[0][0].RtmpInput.StreamName
              MediaLiveMp4InputArn.$: $[0][1].MP4Result.Input.Arn
              MediaLiveMp4InputName.$: $[0][1].MP4Result.Input.Name
              MediaLiveChannelArn.$: $[0][0].ChannelResult.Channel.Arn
              MediaLiveChannelId.$: $[0][0].ChannelResult.Channel.Id
              MediaStoreContainerArn.$: $[0][2].ContainerResult.Container.Arn
            Branches:
              - StartAt: CreateChannel
                States:
                  CreateChannel:
                    Type: Task
                    Comment: ライブ配信 - チャンネルを作成
                    InputPath: $
                    ResultPath: $[0].ChannelResult
                    Resource: arn:aws:states:::aws-sdk:medialive:createChannel
                    Parameters:
                      Name.$: $[0].ChannelInput.Name
                      RoleArn: arn:aws:iam::${self:provider.account}:role/MediaLiveAccessRole
                      ChannelClass: SINGLE_PIPELINE
                      InputAttachments:
                        - InputId.$: $[0].RtmpResult.Input.Id
                          InputAttachmentName.$: $[0].RtmpResult.Input.Name
                        - InputId.$: $[1].MP4Result.Input.Id
                          InputAttachmentName.$: $[1].MP4Result.Input.Name
                          InputSettings:
                            SourceEndBehavior: LOOP
                      Destinations:
                        - Id: MediaStore
                          Settings:
                            - Url.$: States.Format('mediastoressl://{}/{}', $[2].ContainerStatus.Container.Endpoint, $[0].RtmpInput.StreamName)
                        - Id: S3
                          Settings:
                            - Url.$: States.Format('s3ssl://{}{}/live', $[0].ArchiveInput.BucketName, $[0].ArchiveInput.Path)
                      EncoderSettings:
                        GlobalConfiguration:
                          InputEndAction: NONE
                          InputLossBehavior:
                            BlackFrameMsec: 1000
                            InputLossImageType: SLATE
                            InputLossImageColor: "3a3a3a"
                            InputLossImageSlate:
                              Uri.$: $[0].ChannelInput.InputLossImageSlateUri
                        TimecodeConfig:
                          Source: EMBEDDED
                        AudioDescriptions:
                          - Name: オーディオ
                            AudioSelectorName: Default
                        VideoDescriptions:
                          - Name: 動画
                            RespondToAfd: NONE
                            ScalingBehavior: DEFAULT
                            Sharpness: 50
                        OutputGroups:
                          - Name: MediaStore
                            OutputGroupSettings:
                              HlsGroupSettings:
                                AdMarkers: []
                                CaptionLanguageMappings: []
                                CaptionLanguageSetting: OMIT
                                ClientCache: ENABLED
                                CodecSpecification: RFC_4281
                                Destination:
                                  DestinationRefId: MediaStore
                                DirectoryStructure: SINGLE_DIRECTORY
                                DiscontinuityTags: INSERT
                                HlsCdnSettings:
                                  HlsMediaStoreSettings:
                                    ConnectionRetryInterval: 1
                                    FilecacheDuration: 300
                                    MediaStoreStorageClass: TEMPORAL
                                    NumRetries: 10
                                    RestartDelay: 15
                                HlsId3SegmentTagging: DISABLED
                                IFrameOnlyPlaylists: DISABLED
                                IncompleteSegmentBehavior: AUTO
                                IndexNSegments: 10
                                InputLossAction: EMIT_OUTPUT
                                IvInManifest: INCLUDE
                                IvSource: FOLLOWS_SEGMENT_NUMBER
                                KeepSegments: 21
                                ManifestCompression: NONE
                                ManifestDurationFormat: FLOATING_POINT
                                Mode: LIVE
                                OutputSelection: MANIFESTS_AND_SEGMENTS
                                ProgramDateTime: EXCLUDE
                                ProgramDateTimeClock: INITIALIZE_FROM_OUTPUT_TIMECODE
                                ProgramDateTimePeriod: 600
                                RedundantManifest: DISABLED
                                SegmentLength: 10
                                SegmentationMode: USE_SEGMENT_DURATION
                                SegmentsPerSubdirectory: 10000
                                StreamInfResolution: INCLUDE
                                TimedMetadataId3Frame: PRIV
                                TimedMetadataId3Period: 10
                                TsFileMode: SEGMENTED_FILES
                            Outputs:
                              - OutputName.$: States.UUID()
                                OutputSettings:
                                  HlsOutputSettings:
                                    H265PackagingType: HVC1
                                    HlsSettings:
                                      StandardHlsSettings:
                                        AudioRenditionSets: program_audio
                                        M3u8Settings:
                                          AudioFramesPerPes: 4
                                          AudioPids: "492-498"
                                          NielsenId3Behavior: NO_PASSTHROUGH
                                          PcrControl: PCR_EVERY_PES_PACKET
                                          PmtPid: "480"
                                          ProgramNum: 1
                                          Scte35Behavior: NO_PASSTHROUGH
                                          Scte35Pid: "500"
                                          TimedMetadataBehavior: NO_PASSTHROUGH
                                          TimedMetadataPid: "502"
                                          VideoPid: "481"
                                    NameModifier: "_1"
                                AudioDescriptionNames:
                                  - オーディオ
                                CaptionDescriptionNames: []
                                VideoDescriptionName: 動画
                          # - Name: S3
                          #   OutputGroupSettings:
                          #     ArchiveGroupSettings:
                          #       Destination:
                          #         DestinationRefId: S3
                          #       RolloverInterval: 300
                          #   Outputs:
                          #     - OutputName.$: States.UUID()
                          #       OutputSettings:
                          #         ArchiveOutputSettings:
                          #           ContainerSettings:
                          #             M2tsSettings:
                          #               AbsentInputAudioBehavior: "ENCODE_SILENCE"
                          #               Arib: "DISABLED"
                          #               AribCaptionsPid: "507"
                          #               AribCaptionsPidControl: "AUTO"
                          #               AudioBufferModel: "ATSC"
                          #               AudioFramesPerPes: 2
                          #               AudioPids: "482-498"
                          #               AudioStreamType: "DVB"
                          #               BufferModel: "MULTIPLEX"
                          #               CcDescriptor: "DISABLED"
                          #               DvbSubPids: "460-479"
                          #               DvbTeletextPid: "499"
                          #               Ebif: "NONE"
                          #               EbpAudioInterval: "VIDEO_INTERVAL"
                          #               EbpPlacement: "VIDEO_AND_AUDIO_PIDS"
                          #               EsRateInPes: "EXCLUDE"
                          #               EtvPlatformPid: "504"
                          #               EtvSignalPid: "505"
                          #               Klv: "NONE"
                          #               KlvDataPids: "501"
                          #               NielsenId3Behavior: "NO_PASSTHROUGH"
                          #               PatInterval: 100
                          #               PcrControl: "PCR_EVERY_PES_PACKET"
                          #               PcrPeriod: 40
                          #               PmtInterval: 100
                          #               PmtPid: "480"
                          #               ProgramNum: 1
                          #               RateMode: "CBR"
                          #               Scte27Pids: "450-459"
                          #               Scte35Control: "NONE"
                          #               Scte35Pid: "500"
                          #               SegmentationMarkers: "NONE"
                          #               SegmentationStyle: "MAINTAIN_CADENCE"
                          #               TimedMetadataBehavior: "NO_PASSTHROUGH"
                          #               TimedMetadataPid: "502"
                          #               VideoPid: "481"
                          #           NameModifier: "_$rv$"
                          #       AudioDescriptionNames:
                          #         - オーディオ
                          #       CaptionDescriptionNames: []
                          #       VideoDescriptionName: 動画
                          - OutputGroupSettings:
                              HlsGroupSettings:
                                AdMarkers: []
                                CaptionLanguageMappings: []
                                CaptionLanguageSetting: OMIT
                                ClientCache: ENABLED
                                CodecSpecification: RFC_4281
                                Destination:
                                  DestinationRefId: S3
                                DirectoryStructure: SINGLE_DIRECTORY
                                DiscontinuityTags: INSERT
                                HlsId3SegmentTagging: DISABLED
                                IFrameOnlyPlaylists: DISABLED
                                IncompleteSegmentBehavior: AUTO
                                IndexNSegments: 10
                                InputLossAction: EMIT_OUTPUT
                                IvInManifest: INCLUDE
                                IvSource: FOLLOWS_SEGMENT_NUMBER
                                KeepSegments: 21
                                ManifestCompression: NONE
                                ManifestDurationFormat: FLOATING_POINT
                                Mode: VOD
                                OutputSelection: MANIFESTS_AND_SEGMENTS
                                ProgramDateTime: EXCLUDE
                                ProgramDateTimeClock: INITIALIZE_FROM_OUTPUT_TIMECODE
                                ProgramDateTimePeriod: 600
                                RedundantManifest: DISABLED
                                SegmentLength: 10
                                SegmentationMode: USE_SEGMENT_DURATION
                                SegmentsPerSubdirectory: 10000
                                StreamInfResolution: INCLUDE
                                TimedMetadataId3Frame: PRIV
                                TimedMetadataId3Period: 10
                                TsFileMode: SEGMENTED_FILES
                            Outputs:
                              - OutputName.$: States.UUID()
                                OutputSettings:
                                  HlsOutputSettings:
                                    H265PackagingType: HVC1
                                    HlsSettings:
                                      StandardHlsSettings:
                                        AudioRenditionSets: program_audio
                                        M3u8Settings:
                                          AudioFramesPerPes: 4
                                          AudioPids: "492-498"
                                          NielsenId3Behavior: NO_PASSTHROUGH
                                          PcrControl: PCR_EVERY_PES_PACKET
                                          PmtPid: "480"
                                          ProgramNum: 1
                                          Scte35Behavior: NO_PASSTHROUGH
                                          Scte35Pid: "500"
                                          TimedMetadataBehavior: NO_PASSTHROUGH
                                          TimedMetadataPid: "502"
                                          VideoPid: "481"
                                    NameModifier: "_$rv$"
                                AudioDescriptionNames:
                                  - オーディオ
                                CaptionDescriptionNames: []
                                VideoDescriptionName: 動画
                    End: true
              - StartAt: CreateOriginAccessControl
                States:
                  CreateOriginAccessControl:
                    Type: Task
                    Comment: ライブ配信 - CloudFrontのOriginAccessControlを作成
                    InputPath: $
                    ResultPath: $[2].OriginAccessControlResult
                    Resource: arn:aws:states:::aws-sdk:cloudfront:createOriginAccessControl
                    Parameters:
                      OriginAccessControlConfig:
                        Name.$: States.Format('ForMediaStoreOrigin-{}', States.UUID())
                        Description: MediaStoreをオリジンにするCloudFrontディストリビューション用
                        OriginAccessControlOriginType: mediastore
                        SigningBehavior: always
                        SigningProtocol: sigv4
                    Next: CreateDistribution
                  CreateDistribution:
                    Type: Task
                    Comment: ライブ配信 - MediaStoreをオリジンにするCloudFrontディストリビューションを作成
                    InputPath: $
                    ResultPath: $[2].DistributionResult
                    Resource: arn:aws:states:::aws-sdk:cloudfront:createDistribution
                    Parameters:
                      DistributionConfig:
                        CallerReference.$: $[2].ContainerResult.Container.Name
                        Comment: MediaStoreをオリジンにするCloudFrontディストリビューション
                        Enabled: true
                        HttpVersion: http2
                        Origins:
                          Quantity: 1
                          Items:
                          - Id.$: States.Format('{}.data.mediastore.ap-northeast-1.amazonaws.com', $[2].ContainerResult.Container.Name)
                            DomainName.$: $[2].ContainerStatus.Container.Endpoint
                            CustomOriginConfig:
                              HttpPort: 80
                              HttpsPort: 443
                              OriginProtocolPolicy: https-only
                            OriginAccessControlId.$: $[2].OriginAccessControlResult.OriginAccessControl.Id
                        DefaultCacheBehavior:
                          TargetOriginId.$: States.Format('{}.data.mediastore.ap-northeast-1.amazonaws.com', $[2].ContainerResult.Container.Name)
                          ViewerProtocolPolicy: redirect-to-https
                          AllowedMethods:
                            Quantity: 7
                            Items:
                              - GET
                              - HEAD
                              - OPTIONS
                              - PUT
                              - POST
                              - PATCH
                              - DELETE
                          ForwardedValues:
                            QueryString: false
                            Cookies:
                              Forward: none
                            Headers:
                              Quantity: 2
                              Items:
                                - Origin
                                - Access-Con
                          MinTTL: 1
                    Next: PutContainerPolicy
                  PutContainerPolicy:
                    Type: Task
                    Comment: ライブ配信 - チャンネルに対するポリシーを設定
                    InputPath: $
                    ResultPath: $[2].ContainerPolicyResult
                    Resource: arn:aws:states:::aws-sdk:mediastore:putContainerPolicy
                    Parameters:
                      ContainerName.$: $[2].ContainerResult.Container.Name
                      Policy:
                        Version: '2012-10-17'
                        Statement:
                          - Sid: AllowCloudFrontServicePrincipalReadOnly
                            Effect: Allow
                            Principal:
                              AWS: '*'
                            Action:
                              - mediastore:GetObject
                              - mediastore:DescribeObject
                            Resource.$: States.Format('{}/*', $[2].ContainerResult.Container.Arn)
                            Condition:
                              StringEquals:
                                AWS:SourceArn.$: $[2].DistributionResult.Distribution.Arn
                              Bool:
                                aws:SecureTransport: 'true'
                    End: true
              - StartAt: PutCorsPolicy
                States:
                  PutCorsPolicy:
                    Type: Task
                    Comment: ライブ配信 - MediaStoreコンテナに対するCORSポリシーを設定
                    InputPath: $
                    ResultPath: $[2].CorsPolicyResult
                    Resource: arn:aws:states:::aws-sdk:mediastore:putCorsPolicy
                    Parameters:
                      ContainerName.$: $[2].ContainerResult.Container.Name
                      CorsPolicy:
                        - AllowedOrigins:
                            - '*'
                          AllowedMethods:
                            - GET
                            - HEAD
                          AllowedHeaders:
                            - '*'
                          MaxAgeSeconds: 3000
                    Next: PutLifecyclePolicy
                  PutLifecyclePolicy:
                    Type: Task
                    Comment: ライブ配信 - MediaStoreコンテナに対するライフサイクルポリシーを設定
                    InputPath: $
                    ResultPath: $[2].LifecyclePolicyResult
                    Resource: arn:aws:states:::aws-sdk:mediastore:putLifecyclePolicy
                    Parameters:
                      ContainerName.$: $[2].ContainerResult.Container.Name
                      LifecyclePolicy:  {"rules":[{"definition":{"path":[{"wildcard":"*"}],"days_since_create":[{"numeric":[">",1]}]},"action":"EXPIRE"}]}
                    End: true
          RegisterResoursesInfo:
            Type: Task
            Comment: リソース情報を登録
            InputPath: $
            ResultPath: $.RegisterResoursesInfoResult
            Resource: arn:aws:lambda:ap-northeast-1:386661535629:function:furumaru-media-start-updater-stg
            End: True
    deleteMediaLiveMachine:
      name: deleteMediaLiveResoursesFunction-${self:provider.stage}
      role:
        Fn::GetAtt: [defaultRole, Arn]
      definition:
        StartAt: DescribeChannel
        States:
          DescribeChannel:
            Type: Task
            Comment: MediaLiveのチャンネルを取得
            InputPath: $
            ResultPath: $.DescribeChannelResult
            Resource: arn:aws:states:::aws-sdk:medialive:describeChannel
            Parameters:
              ChannelId.$: $.ChannelId
            Next: DeleteChannel
            Catch:
              - ErrorEquals:
                  - MediaLive.NotFoundException
                Comment: チャンネルが存在しない場合は終了
                Next: Pass
          Pass:
            Type: Pass
            End: true
          DeleteChannel:
            Type: Task
            Comment: MediaLiveのチャンネルを削除
            InputPath: $
            ResultPath: $.DeleteChannelResult
            Resource: arn:aws:states:::aws-sdk:medialive:deleteChannel
            Parameters:
              ChannelId.$: $.ChannelId
            Next: DeleteInputMap
          DeleteInputMap:
            Type: Map
            Comment: MediaLiveのInputを削除
            InputPath: $
            ItemsPath: $.DescribeChannelResult.InputAttachments
            ResultPath: $.DeleteInputMapResult
            End: true
            ItemSelector:
              InputId.$: $$.Map.Item.Value.InputId
            MaxConcurrency: 5
            ItemProcessor:
              ProcessorConfig:
                Mode: INLINE
              StartAt: DescribeInput
              States:
                DescribeInput:
                  Type: Task
                  Comment: MediaLiveのInputを取得
                  InputPath: $
                  ResultPath: $.DescribeInputResult
                  Resource: arn:aws:states:::aws-sdk:medialive:describeInput
                  Parameters:
                    InputId.$: $.InputId
                  Next: WaitDettached
                WaitDettached:
                  Type: Wait
                  Seconds: 1
                  Next: CheckInputDetached
                CheckInputDetached:
                  Type: Choice
                  InputPath: $
                  Choices:
                    - Variable: $.DescribeInputResult.State
                      StringEquals: "DETACHED"
                      Next: DeleteInput
                  Default: DescribeInput
                DeleteInput:
                  Type: Task
                  Resource: arn:aws:states:::aws-sdk:medialive:deleteInput
                  InputPath: $
                  Parameters:
                    InputId.$: $.InputId
                  End: true
    deleteCloudFrontMachine:
      name: deleteCloudFrontResoursesFunction-${self:provider.stage}
      role:
        Fn::GetAtt: [defaultRole, Arn]
      definition:
        StartAt: GetDistributionConfig
        States:
          GetDistributionConfig:
            Type: Task
            Comment: CloudFrontのディストリビューション設定を取得
            InputPath: $
            ResultPath: $.GetDistributionConfigResult
            Resource: arn:aws:states:::aws-sdk:cloudfront:getDistributionConfig
            Parameters:
              Id.$: $.DistributionId
            Catch:
              - ErrorEquals:
                  - CloudFront.NoSuchDistribution
                Comment: ディストリビューションが存在しない場合は終了
                Next: Finish
            Next: DisableDistribution
          DisableDistribution:
            Type: Task
            Comment: CloudFrontのディストリビューションを無効化
            InputPath: $
            ResultPath: $.DisableDistributionResult
            Resource:
              Fn::GetAtt: [disableDistribution, Arn]
            Next: WaitDisabled
          WaitDisabled:
            Type: Wait
            Seconds: 1
            Next: GetDistributionStatus
          GetDistributionStatus:
            Type: Task
            Comment: CloudFrontのディストリビューションを取得
            InputPath: $
            ResultPath: $.DistributionStatus
            Resource: arn:aws:states:::aws-sdk:cloudfront:getDistribution
            Parameters:
              Id.$: $.DistributionId
            Next: CheckDistributionDisabled
          CheckDistributionDisabled:
            Type: Choice
            InputPath: $
            Choices:
              - Variable: $.DistributionStatus.Distribution.DistributionConfig.Enabled
                BooleanEquals: false
                Next: CheckDistributionDeployed
            Default: WaitDisabled
          WaitDeployed:
            Type: Wait
            Seconds: 60
            Next: GetDistributionStatus
          CheckDistributionDeployed:
            Type: Choice
            InputPath: $
            Choices:
              - Variable: $.DistributionStatus.Distribution.Status
                StringEquals: "Deployed"
                Next: DeleteDistribution
            Default: WaitDeployed
          DeleteDistribution:
            Type: Task
            Comment: CloudFrontのディストリビューションを削除
            InputPath: $
            Resource: arn:aws:states:::aws-sdk:cloudfront:deleteDistribution
            Parameters:
              Id.$: $.DistributionId
              IfMatch.$: $.DistributionStatus.ETag
            Next: Finish
          Finish:
            Type: Pass
            End: true
    deleteMediaStoreMachine:
      name: deleteMediaStoreResoursesFunction-${self:provider.stage}
      role:
        Fn::GetAtt: [defaultRole, Arn]
      definition:
        StartAt: ExtractContainerName
        States:
          ExtractContainerName:
            Type: Pass
            InputPath: $
            ResultPath: $.ExtractContainerNameResult
            Parameters:
              ContainerName.$: States.ArrayGetItem(States.StringSplit($.MediaStoreContainerArn, '/'), 1)
            Next: CheckContainerExists
          CheckContainerExists:
            Type: Task
            Comment: MediaStoreのコンテナがあるか確認
            InputPath: $
            ResultPath: $.CheckContainerExistsResult
            Resource: arn:aws:states:::aws-sdk:mediastore:describeContainer
            Parameters:
              ContainerName.$: $.ExtractContainerNameResult.ContainerName
            Catch:
              - ErrorEquals:
                  - MediaStore.ContainerNotFoundException
                Comment: コンテナが存在しない場合は終了
                Next: Finish
            Next: ListMediaStoreItems
          ListMediaStoreItems:
            Type: Task
            Comment: MediaStoreのコンテナ内にオブジェクトがあるか確認
            InputPath: $
            ResultPath: $.ListMediaStoreItemsResult
            Resource:
              Fn::GetAtt: [listMediaStoreItems, Arn]
            Next: CheckObjectExists
          CheckObjectExists:
            Type: Choice
            InputPath: $
            Choices:
              - Variable: $.ListMediaStoreItemsResult.Items[0]
                IsPresent: false
                Next: DeleteContainer
            Default: DeleteObjects
          DeleteObjects:
            Type: Task
            Comment: MediaStoreのコンテナ内のオブジェクトを削除
            InputPath: $
            ResultPath: $.DeleteObjectsResult
            Resource:
              Fn::GetAtt: [deleteMediaStoreObjects, Arn]
            Next: DeleteContainer
          DeleteContainer:
            Type: Task
            Comment: MediaStoreのコンテナを削除
            InputPath: $
            Resource: arn:aws:states:::aws-sdk:mediastore:deleteContainer
            Parameters:
              ContainerName.$: $.ExtractContainerNameResult.ContainerName
            Next: Finish
          Finish:
            Type: Pass
            End: true

plugins:
  - serverless-step-functions
