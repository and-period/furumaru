# Copilot Instructions (for Go + TypeScript / Nuxt.js v4)
最終更新: 2025-08-19

このリポジトリでの GitHub Copilot のふるまいを定義します。**まずリポジトリ内の設定を読み取り、それに厳密に合わせて提案**してください。

---

## 1) 参照すべきファイル / 優先順位
1. **CLAUDE.md**, **.claude/** 配下の設定・規約（存在する場合。命名・設計方針・レビュー観点を同期）
2. **.editorconfig**, **.gitignore**
3. **Go**: `go.mod`, `go.sum`, `Makefile`, `Dockerfile[*]`, `cmd/**`, `internal/**`, `pkg/**`, `.golangci.yml` / `.golangci.yaml`
4. **TypeScript / Nuxt v4**: `package.json`, `pnpm-lock.yaml`/`yarn.lock`/`package-lock.json`, `nuxt.config.*`, `tsconfig.*`, `.eslintrc.*`, `.prettierrc*`, `vitest.config.*`
5. API/契約: `openapi.*` or `schema/**` or `proto/**`
6. インフラ: `infra/**`, `deploy/**`, CI: `.github/workflows/**`

> **方針が衝突したら**: リポジトリの設定ファイル > CLAUDE.md/.claude > 本ファイル の順で優先。

---

## 2) 出力・コミュニケーションのルール
- **コードレビュー/説明・コメントは日本語**で記述する。
- コード提案は既存の**言語/フレームワーク/記法**（Go / TS, Nuxt v4, Composition API, `<script setup>` など）に合わせる。
- 既存のコーディング規約（lint/format）に**100%準拠**する（ESLint・Prettier・golangci-lint・`go fmt`）。
- **推測で依存追加しない**。必要な場合は根拠・代替案・影響範囲を短く示す。
- ファイル構成・命名・I/O 契約（型・DTO・エンドポイント）は**既存を最優先で踏襲**。変更が必要なら理由と移行ステップを添える。
- 変更提案は**最小差分（small, focused diff）**で、既存のテストや型を壊さない。

---

## 3) Go(Guidelines)
- **標準**: Go1.x の標準機能優先。`context.Context` を**外部境界から内部に伝播**。キャンセル/タイムアウト尊重。
- **エラー**: `errors.Is/As`、`fmt.Errorf("%w", err)` による**ラップ**。ユーザー向け/ログ向けの境界を分離。
- **ログ**: 既存ロガー（例: `log/slog` 等）に合わせる。**構造化ログ**でフィールドを付与。
- **並行**: 共有可変データへは**排他**。`errgroup`/`WaitGroup` を安全に。ゴルーチンの**リーク禁止**。
- **設計**: `internal/` を活用。インタフェースは**呼ばれる側ではなく使われる側**に置く。DIを意識したテスト容易性。
- **テスト**: **テーブルドリブン**、`t.Helper()`、`-race` 前提。外部I/Oは**インタフェースで注入**しモック可能に。
- **パフォーマンス**: まず**可読性**。必要時のみ `sync.Pool` 等を検討。ベンチは `testing.B` で根拠を残す。

---

## 4) TypeScript / Nuxt.js v4(Guidelines)
- **型**: `strict` を前提に**型安全**を維持。暗黙の `any`・型ガード不足を避ける。
- **Nuxt v4**: Composition API / `<script setup>`, `defineProps/defineEmits/defineModel` を適切に。**SSR安全**（`process.client`/`process.server` や `useAsyncData` のデータ取得タイミング）。
- **状態管理**: 既存の選択（Pinia等）に合わせる。**副作用は store/action へ集約**。
- **API 呼び出し**: 既存の `useFetch`/`$fetch`/`server/api/**` のパターンを踏襲。**型付き DTO** を共有（`types/**` 等）。
- **スタイル/アクセシビリティ**: 既存の UI ライブラリ/設計に合わせ、**a11y**（ラベル、フォーカス、コントラスト）に配慮。
- **テスト**: `vitest`/`@testing-library/vue` 想定。**ユーザー視点**の DOM 断言を優先（実装詳細への過剰依存を避ける）。

---

## 5) セキュリティ・品質チェック（変更時に必ず走査）
- **入力検証**: サーバ/クライアント双方。型 + スキーマ（zod などがあれば準拠）。
- **認可/認証**: 既存ミドルウェアやガードに**必ず**統合。フロントは**表示制御のみ**で過信しない。
- **シークレット**: **コードに直書き禁止**。`runtimeConfig`/環境変数を利用。
- **依存**: 既存バージョン帯で互換。脆弱性アラートはアップデート方針に合わせ段階的に。
- **i18n/timezone**: 既存ロケール/日付処理に準拠。サーバとクライアントのフォーマット差異に注意。
- **パフォーマンス**: SSR/クライアントで**不要レンダリング回避**（`computed`/`watch` の適正化、キー指定、リスト最適化）。
- **アクセシビリティ**: フォーム/モーダル/フォーカストラップ/キーボード操作を確認。

---

## 6) レビューコメントのフォーマット（日本語）
- **概要**: 変更の意図と影響（正/負）を一言で。
- **良い点**: 箇条書きで最小 1 点。
- **改善提案**: **根拠**と**例（短いコードブロック）**を提示。
- **安全性**: 破壊的変更/回帰リスク、マイグレーションの要否。
- **チェック**: テスト・lint・型チェックの観点を短く列挙。

例:
> **改善提案**  
> - `context` が伝播していないため、タイムアウト制御が効きません。`Do(ctx, ...)` のように受け渡してください。  
> - Nuxt ページで `useAsyncData` のキーが固定のためキャッシュ衝突の恐れ。パラメータを含めたキーへ。

---

## 7) 変更提案の出し方
- まず **最小差分の修正例** を提示し、必要なら代替案 A/B を続けて列挙。
- ファイル新規作成時は**配置理由**（どのレイヤ/責務か）を 1 行コメントで示す。
- **テストの追加/修正**まで提案（Go: テーブルドリブン、TS: vitest）。
- 既存のスクリプトを尊重（例: `make test`, `pnpm test`）。**通らない提案は出さない**。

---

## 8) 禁止 / 回避事項
- 根拠のない API/スキーマの**新規定義**、密結合の導入、**不要な依存追加**。
- **ハードコードされた URL/秘密情報**、環境に依存したパス。
- ランダムな命名/一貫性のないディレクトリ構成変更。
- 既存規約に反するログ/フォーマット/リンタ無視コメントの乱用。

---

## 9) 典型ユースのスニペット指針
- **Go エラー処理**:  
  ```go
  if err != nil {
      return nil, fmt.Errorf("fetch user %s: %w", id, err)
  }
